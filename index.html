<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>青年活動レポートダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    /* ===== ベース：パステルグラデ背景 ===== */
    body {
      margin: 0;
      font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #FFE6EE 0%, #EDEBFF 50%, #E0F2FE 100%);
      color: #334155; /* slate-700 */
    }

    /* ===== メインコンテナ：白ガラスカード ===== */
    .app {
      max-width: 1200px;
      margin: 32px auto 40px;
      padding: 24px 24px 32px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: 24px;
      box-shadow: 0 24px 60px rgba(148, 163, 184, 0.45);
    }

    header { margin-bottom: 16px; }
    header h1 {
      font-size: 1.9rem;
      font-weight: 700;
      margin: 0 0 4px;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #0f172a; /* slate-900 */
    }
    header h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: conic-gradient(from 180deg, #f9a8d4, #a5b4fc, #6ee7b7, #f9a8d4);
      box-shadow: 0 0 10px rgba(244, 114, 182, 0.8);
    }
    header .subtitle {
      font-size: 0.85rem;
      color: #6b7280; /* gray-500 */
      line-height: 1.6;
    }

    /* ===== コントロールバー ===== */
    .control-bar {
      margin-top: 20px;
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 12px 30px rgba(148, 163, 184, 0.35);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .control-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-right: 16px;
    }
    .control-label {
      font-size: 0.85rem;
      color: #6b7280;
    }

    select {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      padding: 6px 28px 6px 12px;
      color: #334155;
      font-size: 0.9rem;
      outline: none;
      min-width: 150px;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.25);
    }
    select:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px #60a5fa;
    }

    .mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #e5e7eb;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(148, 163, 184, 0.4);
    }
    .mode-btn {
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      color: #6b7280;
      background: transparent;
      transition: all .15s ease-out;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .mode-btn.active {
      background: linear-gradient(135deg,#bfdbfe,#a5b4fc);
      color: #0f172a;
      font-weight: 600;
    }

    .pill-button {
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: linear-gradient(135deg,#eff6ff,#e0f2fe);
      color: #1e293b;
      font-size: 0.8rem;
      padding: 6px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .15s;
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.5);
    }
    .pill-button:hover {
      background: linear-gradient(135deg,#dbeafe,#bfdbfe);
      transform: translateY(-1px);
    }

    .status-text {
      font-size: 0.8rem;
      color: #fb7185; /* rose-400 */
      white-space: nowrap;
    }

    /* ===== サマリーカード / 共通カード ===== */
    .summary-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
    }

    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: 20px;
      padding: 12px 14px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 14px 28px rgba(148, 163, 184, 0.45);
    }
    .card-title {
      font-size: 0.78rem;
      color: #64748b;
      margin-bottom: 6px;
    }
    .card-value {
      font-size: 1.3rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #0f172a;
    }

    /* ===== グラフエリア ===== */
    .chart-row {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 16px;
    }
    .chart-card {
      height: 380px;
      display: flex;
      flex-direction: column;
      padding: 14px 16px 32px;
    }
    .chart-card.radar-card {
      height: 380px;
    }
    .chart-title {
      font-size: 0.85rem;
      color: #6b7280;
    }
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .chart-card canvas {
      flex: 1;
    }

    .metric-select {
      background: rgba(255,255,255,0.9);
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      padding: 4px 24px 4px 10px;
      color: #334155;
      font-size: 0.78rem;
      outline: none;
      min-width: 140px;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.35);
    }

    /* ===== 下段：コメント & AI分析 ===== */
    .bottom-row {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 16px;
    }
    .comments-card, .ai-card {
      max-height: 320px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .scroll-body {
      margin-top: 8px;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
    }
    .scroll-body::-webkit-scrollbar {
      width: 6px;
    }
    .scroll-body::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 8px;
    }

    .comment-item {
      border-bottom: 1px dashed rgba(209, 213, 219, 0.9);
      padding: 6px 0 8px;
      font-size: 0.8rem;
    }
    .comment-meta {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .comment-good {
      color: #0ea5e9; /* sky-500 */
      margin-bottom: 2px;
    }
    .comment-improve {
      color: #f97316; /* orange-500 */
    }

    .ai-text {
      font-size: 0.83rem;
      color: #475569;
      line-height: 1.7;
    }
    .ai-chip {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(191, 219, 254, 0.8);
      border: 1px solid rgba(129, 140, 248, 0.8);
      color: #1e293b;
      margin-right: 6px;
    }
    .ai-section-title {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 2px;
      color: #3b82f6;
    }

    footer {
      margin-top: 28px;
      font-size: 0.7rem;
      color: #9ca3af;
      text-align: right;
    }

    @media (max-width: 840px) {
      .chart-row,
      .bottom-row {
        grid-template-columns: minmax(0, 1fr);
      }
      .control-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .status-text {
        white-space: normal;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1><span class="logo-dot"></span>青年活動レポートダッシュボード</h1>
    <div class="subtitle">
      行事別・月別に、5段階評価・満足度・雰囲気・再参加意向・コメントを自動で集計し、<br>
      青年部の伝道・育成・場づくりをデータで振り返るためのダッシュボードです。
    </div>
  </header>

  <!-- コントロールバー -->
  <div class="control-bar">
    <div class="control-group">
      <span class="control-label">表示モード：</span>
      <div class="mode-toggle">
        <button id="modeEvent" class="mode-btn active" data-mode="event">行事別</button>
        <button id="modeMonth" class="mode-btn" data-mode="month">月別</button>
        <button id="modeEventMonth" class="mode-btn" data-mode="eventMonth">行事×月</button>
      </div>
    </div>

    <div class="control-group" id="eventSelectGroup">
      <span class="control-label">行事を選択：</span>
      <select id="eventSelect"></select>
    </div>

    <div class="control-group" id="monthSelectGroup" style="display:none;">
      <span class="control-label">月を選択：</span>
      <select id="monthSelect"></select>
    </div>

    <!-- ★ 追加：区分セレクト -->
    <div class="control-group" id="kubunSelectGroup">
      <span class="control-label">区分：</span>
      <select id="kubunSelect">
        <option value="all">全て</option>
        <option value="小中高生">小中高生</option>
        <option value="青年">青年</option>
        <option value="家庭青年">家庭青年</option>
        <option value="壮年">壮年</option>
        <option value="婦人">婦人</option>
        <option value="その他">その他</option>
      </select>
    </div>
    <!-- ここまで -->

    <div class="control-group">
      <button id="csvBtn" class="pill-button">
        ⬇ CSVエクスポート
      </button>
    </div>

    <div class="control-group" style="margin-left:auto;">
      <span id="status" class="status-text"></span>
    </div>
  </div>

  <!-- サマリー -->
  <div id="summaryCards" class="summary-grid"></div>

  <!-- グラフ -->
  <div class="chart-row">
    <!-- レーダーチャート -->
    <div class="card chart-card radar-card">
      <div class="chart-title">レーダーチャート（バランス）</div>
      <canvas id="radarChart"></canvas>
    </div>
    <!-- 月別平均棒グラフ -->
    <div class="card chart-card">
      <div class="chart-header">
        <div class="chart-title">指標の推移（月別平均）</div>
        <select id="metricSelect" class="metric-select">
          <option value="timeFlow">時間・構成</option>
          <option value="content">内容の質</option>
          <option value="mood">雰囲気・安心感</option>
          <option value="emotion">楽しさ・やりがい</option>
          <option value="satisfy" selected>満足度</option>
          <option value="rejoin">再参加意向</option>
        </select>
      </div>
      <canvas id="lineChart"></canvas>
    </div>
  </div>

  <!-- コメント & AI風分析 -->
  <div class="bottom-row">
    <div class="card comments-card">
      <div class="chart-title">参加者の声（よかった点・改善点）</div>
      <div id="commentsBox" class="scroll-body"></div>
    </div>
    <div class="card ai-card">
      <div class="chart-title">AI風 分析コメント＆次の一手の提案（ローカルルールベース）</div>
      <div id="aiInsight" class="scroll-body ai-text"></div>
    </div>
  </div>

  <footer>
    ※このダッシュボードは Googleフォームの「感想フォーム（回答）」の内容を元に自動更新されます。
  </footer>
</div>

<script>
  /***** 設定 *****/
  const SHEET_ID = '1JQoma8Vde9k7iWsCyxVJf0f_3QrFh7pECMMHhBkQejY';
  const GID = '0';

  let allData = [];
  let byEvent = new Map();
  let byMonth = new Map();
  let currentMode = 'event';        // 'event' | 'month' | 'eventMonth'
  let currentSummary = null;
  let currentMetric = 'satisfy';    // 時間・構成 etc...

  /***** ユーティリティ：日付表示用 *****/
  function formatDateLabel(raw) {
    if (!raw) return '';

    if (raw instanceof Date && !isNaN(raw)) {
      const y = raw.getFullYear();
      const m = ('0' + (raw.getMonth() + 1)).slice(-2);
      const d = ('0' + raw.getDate()).slice(-2);
      return `${y}/${m}/${d}`;
    }

    const str = String(raw).trim();

    // gviz の "Date(2025,11,6)" 形式をパース（month は 0 始まりなので +1）
    let mDate = str.match(/Date\((\d{4}),(\d{1,2}),(\d{1,2})\)/);
    if (mDate) {
      const y = Number(mDate[1]);
      const mo = Number(mDate[2]) + 1;
      const d = Number(mDate[3]);
      const mm = ('0' + mo).slice(-2);
      const dd = ('0' + d).slice(-2);
      return `${y}/${mm}/${dd}`;
    }

    // 通常の文字列日付
    const d = new Date(str);
    if (!isNaN(d)) {
      const y = d.getFullYear();
      const mo = ('0' + (d.getMonth() + 1)).slice(-2);
      const dd = ('0' + d.getDate()).slice(-2);
      return `${y}/${mo}/${dd}`;
    }
    return str;
  }

  /***** Google Sheets から JSONP で取得 *****/
  function loadGvizJson() {
    return new Promise(function (resolve, reject) {
      window.google = window.google || {};
      window.google.visualization = window.google.visualization || {};
      window.google.visualization.Query = window.google.visualization.Query || {};
      window.google.visualization.Query.setResponse = function (json) {
        resolve(json);
      };

      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}`;
      const script = document.createElement('script');
      script.src = url;
      script.onerror = () => reject(new Error('script load error'));
      document.head.appendChild(script);
    });
  }

  async function fetchSheetData() {
    const json = await loadGvizJson();
    const rows = json.table.rows || [];

    const data = [];
    for (const row of rows) {
      const c = row.c;
      if (!c) continue;
      const get = (i) => (c[i] && c[i].v != null) ? c[i].v : null;
      if (!get(1)) continue; // Q1 参加した活動名

      data.push({
        timestamp: get(0),
        eventName: String(get(1) || '').trim(),
        date:      get(2),
        name:      get(3),
        kubun:     get(4),
        q5:  parseScore(get(5)),
        q6:  parseScore(get(6)),
        q7:  parseScore(get(7)),
        q8:  parseScore(get(8)),
        q9:  parseScore(get(9)),
        q10: parseScore(get(10)),
        q11: parseScore(get(11)),
        q12: parseScore(get(12)),
        q13: parseScore(get(13)),
        good:    get(14),
        improve: get(15)
      });
    }
    return data;
  }

  function parseScore(v) {
    if (v === null || v === undefined || v === '') return null;
    if (typeof v === 'number') return v;
    const m = String(v).match(/^(\d)/);
    return m ? Number(m[1]) : null;
  }

  /***** 集計ロジック *****/
  function groupDataStructures(data) {
    byEvent = new Map();
    byMonth = new Map();

    for (const r of data) {
      const eKey = r.eventName || '（未設定）';
      if (!byEvent.has(eKey)) byEvent.set(eKey, []);
      byEvent.get(eKey).push(r);

      const monthKey = getMonthKey(r.date || r.timestamp);
      if (!byMonth.has(monthKey)) byMonth.set(monthKey, []);
      byMonth.get(monthKey).push(r);
    }
  }

  // 活動月キー (YYYY-MM) を返す
  function getMonthKey(raw) {
    if (!raw) return '未分類';

    if (raw instanceof Date && !isNaN(raw)) {
      const y = raw.getFullYear();
      const m = ('0' + (raw.getMonth() + 1)).slice(-2);
      return `${y}-${m}`;
    }

    const str = String(raw).trim();

    // "Date(2025,11,6)" => 2025-12
    let mDate = str.match(/Date\((\d{4}),(\d{1,2}),(\d{1,2})\)/);
    if (mDate) {
      const y = Number(mDate[1]);
      const mo = Number(mDate[2]) + 1;
      const mm = ('0' + mo).slice(-2);
      return `${y}-${mm}`;
    }

    // "2025/12/06" など
    const m = str.match(/(\d{4})\D(\d{1,2})/);
    if (m) {
      const y = m[1];
      const mm = ('0' + m[2]).slice(-2);
      return `${y}-${mm}`;
    }

    const d = new Date(str);
    if (isNaN(d)) return '未分類';
    const y2 = d.getFullYear();
    const m2 = ('0' + (d.getMonth() + 1)).slice(-2);
    return `${y2}-${m2}`;
  }

  // 1レコードに対する指標値
  function getMetricValue(row, metricKey) {
    switch (metricKey) {
      case 'timeFlow':
        if (typeof row.q5 === 'number' && typeof row.q6 === 'number') return (row.q5 + row.q6) / 2;
        if (typeof row.q5 === 'number') return row.q5;
        if (typeof row.q6 === 'number') return row.q6;
        return null;
      case 'content':
        return row.q7;
      case 'mood':
        if (typeof row.q8 === 'number' && typeof row.q9 === 'number') return (row.q8 + row.q9) / 2;
        if (typeof row.q8 === 'number') return row.q8;
        if (typeof row.q9 === 'number') return row.q9;
        return null;
      case 'emotion':
        if (typeof row.q10 === 'number' && typeof row.q11 === 'number') return (row.q10 + row.q11) / 2;
        if (typeof row.q10 === 'number') return row.q10;
        if (typeof row.q11 === 'number') return row.q11;
        return null;
      case 'satisfy':
        return row.q12;
      case 'rejoin':
        return row.q13;
      default:
        return null;
    }
  }

  const metricNames = {
    timeFlow: '時間・構成',
    content: '内容の質',
    mood: '雰囲気・安心感',
    emotion: '楽しさ・やりがい',
    satisfy: '満足度',
    rejoin: '再参加意向'
  };

  // 月別平均シリーズを作成
  function buildMonthlySeries(rows, metricKey) {
    const map = new Map(); // key: month, value: [scores]

    rows.forEach(r => {
      const v = getMetricValue(r, metricKey);
      if (typeof v !== 'number') return;
      const key = getMonthKey(r.date || r.timestamp);
      if (key === '未分類') return;
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(v);
    });

    const months = Array.from(map.keys()).sort();
    const values = months.map(m => {
      const arr = map.get(m);
      return arr.reduce((a,b) => a+b, 0) / arr.length;
    });

    return { labels: months, values };
  }

  function calcSummary(rows, label) {
    if (!rows || rows.length === 0) return null;
    const avg = (arr) => {
      const nums = arr.filter(v => typeof v === 'number');
      if (!nums.length) return null;
      return nums.reduce((a,b) => a+b, 0) / nums.length;
    };

    const avgTimeFlow = avg(rows.map(r => getMetricValue(r, 'timeFlow')));
    const avgContent = avg(rows.map(r => getMetricValue(r, 'content')));
    const avgMood = avg(rows.map(r => getMetricValue(r, 'mood')));
    const avgEmotion = avg(rows.map(r => getMetricValue(r, 'emotion')));
    const avgSatisfy = avg(rows.map(r => getMetricValue(r, 'satisfy')));
    const avgRejoin = avg(rows.map(r => getMetricValue(r, 'rejoin')));

    const history = rows
      .filter(r => r.q12 != null)
      .slice()
      .sort((a,b) => new Date(a.date || a.timestamp) - new Date(b.date || b.timestamp))
      .map(r => ({
        date: formatDateLabel(r.date || r.timestamp),
        satisfy: r.q12
      }));

    const comments = rows
      .filter(r =>
        (r.good && String(r.good).trim() !== '') ||
        (r.improve && String(r.improve).trim() !== '')
      )
      .slice()
      .sort((a,b) => new Date(b.date || b.timestamp) - new Date(a.date || a.timestamp))
      .map(r => ({
        date: formatDateLabel(r.date || r.timestamp),
        eventName: r.eventName,
        good: r.good,
        improve: r.improve
      }));

    return {
      label,
      count: rows.length,
      avgTimeFlow,
      avgContent,
      avgMood,
      avgEmotion,
      avgSatisfy,
      avgRejoin,
      history,
      comments
    };
  }

  /***** Chart.js 描画 *****/
  let radarChart, lineChart;

  function updateCharts(summary, rows) {
    const radarCtx = document.getElementById('radarChart').getContext('2d');
    const lineCtx = document.getElementById('lineChart').getContext('2d');

    if (radarChart) radarChart.destroy();
    if (lineChart) lineChart.destroy();

    // --- レーダーチャート ---
    const labels = ['時間・構成', '内容の質', '雰囲気・安心感', '楽しさ・やりがい', '満足度', '再参加意向'];
    const data = [
      summary.avgTimeFlow,
      summary.avgContent,
      summary.avgMood,
      summary.avgEmotion,
      summary.avgSatisfy,
      summary.avgRejoin
    ];

    radarChart = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels,
        datasets: [{
          label: summary.label,
          data,
          fill: true,
          borderWidth: 2,
          borderColor: 'rgba(129,140,248,1)',       // パステルラベンダー
          backgroundColor: 'rgba(129,140,248,0.25)',
          pointBackgroundColor: 'rgba(129,140,248,1)',
          pointBorderColor: '#ffffff',
          pointRadius: 3,
          pointHoverRadius: 4
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#64748b' } }  // slate-500
        },
        scales: {
          r: {
            min: 1,
            max: 5,
            ticks: {
              stepSize: 1,
              color: '#94a3b8',
              backdropColor: 'rgba(0,0,0,0)'
            },
            grid: {
              color: 'rgba(203,213,225,0.9)',
              lineWidth: 1
            },
            angleLines: {
              color: 'rgba(148,163,184,0.7)',
              lineWidth: 1
            },
            pointLabels: { color: '#64748b' }
          }
        }
      }
    });

    // --- 月別平均棒グラフ ---
    const series = buildMonthlySeries(rows, currentMetric);

    lineChart = new Chart(lineCtx, {
      type: 'bar',
      data: {
        labels: series.labels,
        datasets: [{
          label: metricNames[currentMetric],
          data: series.values,
          backgroundColor: 'rgba(96,165,250,0.8)',   // sky-400
          hoverBackgroundColor: 'rgba(59,130,246,0.9)',
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#64748b' } }
        },
        scales: {
          x: {
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(226,232,240,0.9)' }
          },
          y: {
            min: 1,
            max: 5,
            ticks: { stepSize: 1, color: '#94a3b8' },
            grid: { color: 'rgba(226,232,240,0.9)' }
          }
        }
      }
    });
  }

  /***** UI更新 *****/
  function updateSummaryCards(summary) {
    const box = document.getElementById('summaryCards');
    box.innerHTML = '';

    const items = [
      ['集計対象', summary.label],
      ['回答数', summary.count],
      ['時間・構成', summary.avgTimeFlow?.toFixed(2)],
      ['内容の質', summary.avgContent?.toFixed(2)],
      ['雰囲気・安心感', summary.avgMood?.toFixed(2)],
      ['楽しさ・やりがい', summary.avgEmotion?.toFixed(2)],
      ['満足度', summary.avgSatisfy?.toFixed(2)],
      ['再参加意向', summary.avgRejoin?.toFixed(2)]
    ];

    for (const [title, value] of items) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="card-title">${title}</div>
        <div class="card-value">${value != null ? value : '-'}</div>
      `;
      box.appendChild(div);
    }
  }

  function updateComments(summary) {
    const box = document.getElementById('commentsBox');
    if (!summary.comments.length) {
      box.innerHTML = '<span style="color:#9ca3af;">まだコメントはありません。</span>';
      return;
    }
    box.innerHTML = '';
    summary.comments.forEach(c => {
      const div = document.createElement('div');
      div.className = 'comment-item';
      div.innerHTML = `
        <div class="comment-meta">${c.date || ''} ｜ ${c.eventName || ''}</div>
        ${c.good ? `<div class="comment-good">◎ ${c.good}</div>` : ''}
        ${c.improve ? `<div class="comment-improve">△ ${c.improve}</div>` : ''}
      `;
      box.appendChild(div);
    });
  }

  /***** 「AI風」分析コメント生成（そのまま） *****/
  function generateInsight(summary, mode) {
    if (!summary) return 'データがありません。';

    const labelWord = mode === 'event' ? 'この行事'
                    : mode === 'month' ? 'この月の活動全体'
                    : 'この行事×月';

    const s = summary;
    const lines = [];
    const chips = [];

    if (s.avgSatisfy >= 4.5) chips.push('高満足度');
    else if (s.avgSatisfy <= 3) chips.push('満足度テコ入れ');
    if (s.avgMood >= 4.3) chips.push('雰囲気◎');
    if (s.avgContent >= 4.3) chips.push('内容の質◎');

    if (s.avgSatisfy != null) {
      if (s.avgSatisfy >= 4.5) {
        lines.push(`${labelWord}は<strong>非常に高い満足度</strong>（平均 ${s.avgSatisfy.toFixed(2)}）が得られています。今の方向性を軸にしつつ、継続・再現性を意識すると良さそうです。`);
      } else if (s.avgSatisfy >= 4.0) {
        lines.push(`${labelWord}は概ね良好な評価（満足度 ${s.avgSatisfy.toFixed(2)}）です。あと半歩上げるには、「一番印象に残る瞬間」を意図的に設計してあげると効果的です。`);
      } else {
        lines.push(`${labelWord}の満足度（${s.avgSatisfy.toFixed(2)}）はやや伸び悩んでいます。特に低くなっている観点を1つだけ決めて、そこに的を絞って改善してみると変化が見えやすいです。`);
      }
    }

    const pairs = [
      ['時間・構成', s.avgTimeFlow],
      ['内容の質', s.avgContent],
      ['雰囲気・安心感', s.avgMood],
      ['楽しさ・やりがい', s.avgEmotion],
      ['再参加意向', s.avgRejoin]
    ];
    const sorted = pairs
      .filter(([,v]) => v != null)
      .sort((a,b) => b[1] - a[1]);

    if (sorted.length >= 2) {
      const best = sorted[0];
      const weak = sorted[sorted.length - 1];
      lines.push(
        `特に評価が高いのは「<strong>${best[0]}</strong>」（${best[1].toFixed(2)}）です。一方で「<strong>${weak[0]}</strong>」（${weak[1].toFixed(2)}）は相対的に弱めなので、ここを1段階だけ引き上げる工夫をすると、全体の印象がぐっと良くなります。`
      );
    }

    if (s.history && s.history.length >= 2) {
      const first = s.history[0].satisfy;
      const last = s.history[s.history.length - 1].satisfy;
      const diff = last - first;
      if (Math.abs(diff) >= 0.5) {
        if (diff > 0) {
          lines.push(`満足度の推移を見ると、開始時より<strong>約 ${diff.toFixed(2)} ポイント改善</strong>しています。この流れを維持するために「うまくいった要素」をメモしてチームで共有しておくと再現しやすくなります。`);
        } else {
          lines.push(`満足度は初期より<strong>約 ${Math.abs(diff).toFixed(2)} ポイント低下</strong>しています。最近のコメントから「負担感・時間・内容の難しさ」など、共通するキーワードがないか確認してみると原因ヒントが見つかるかもしれません。`);
        }
      }
    }

    if (summary.comments && summary.comments.length) {
      lines.push(`参加者の「よかった点」は、次回以降の<strong>残すべき要素</strong>のヒントです。特に頻出しているワード（例：雰囲気・語り・証し・分かち合いなど）をピックアップして、「必ず入れる定番パーツ」として設計しておくと、安定感のある集会づくりにつながります。`);
    } else {
      lines.push(`まだコメントは少なめなので、フォーム内に「一言だけでも大歓迎です！」などの声がけを入れてみると、参加者の本音が集まりやすくなります。`);
    }

    if (mode === 'event') {
      lines.push(`最後に、この行事のPDCAとしては「①一番手応えのある観点を守る」「②一番低い観点を1段階だけ上げる小さな工夫を試す」「③その結果を次回のグラフで確認する」の3ステップで回していくと、数字と実感が結びついた改善サイクルになります。`);
    } else if (mode === 'month') {
      lines.push(`月別で見ると、行事ごとのバラつきが平準化されて見えます。満足度の低い月は「行事の偏り」や「時期的な忙しさ」の影響もあるので、翌月以降のスケジュール調整や内容配分の見直しにも活用できます。`);
    } else {
      lines.push(`行事×月で見ることで、「どのタイミングのこの行事が特に刺さっているか／伸び悩んでいるか」がはっきりします。良かった組み合わせはモデルケースとして、他の月にも展開していくと効果的です。`);
    }

    let html = '';
    if (chips.length) {
      html += chips.map(c => `<span class="ai-chip">${c}</span>`).join('') + '<br>';
    }
    html += `<div class="ai-section-title">1. 全体の印象</div>${lines[0] || ''}`;
    if (lines[1]) html += `<div class="ai-section-title">2. 強みと弱み</div>${lines[1]}`;
    if (lines[2]) html += `<div class="ai-section-title">3. 推移から見えるポイント</div>${lines[2]}`;
    if (lines[3]) html += `<div class="ai-section-title">4. 参加者の声をどう活かすか</div>${lines[3]}`;
    if (lines[4]) html += `<div class="ai-section-title">5. 次の一手</div>${lines[4]}`;
    return html;
  }

  function updateInsight(summary, mode) {
    const box = document.getElementById('aiInsight');
    box.innerHTML = generateInsight(summary, mode);
  }

  /***** CSVエクスポート *****/
  function exportCsv(rows) {
    if (!rows || !rows.length) {
      alert('エクスポート対象のデータがありません。');
      return;
    }
    const header = [
      'タイムスタンプ','活動名','実施日','名前','区分',
      'Q5_時間','Q6_進行','Q7_学び','Q8_雰囲気','Q9_つながり',
      'Q10_楽しさ','Q11_参加してよかった','Q12_満足度','Q13_再参加',
      'よかった点','改善してほしい点'
    ];
    const lines = [header.join(',')];

    const esc = (v) => {
      if (v === null || v === undefined) return '';
      const s = String(v).replace(/"/g,'""');
      return `"${s}"`;
    };

    rows.forEach(r => {
      const row = [
        esc(formatDateLabel(r.timestamp)),
        esc(r.eventName),
        esc(formatDateLabel(r.date)),
        esc(r.name),
        esc(r.kubun),
        esc(r.q5), esc(r.q6), esc(r.q7), esc(r.q8), esc(r.q9),
        esc(r.q10), esc(r.q11), esc(r.q12), esc(r.q13),
        esc(r.good),
        esc(r.improve)
      ];
      lines.push(row.join(','));
    });

    const blob = new Blob([lines.join('\r\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const stamp = new Date().toISOString().slice(0,10);
    let modeLabel;
    if (currentMode === 'event') {
      modeLabel = document.getElementById('eventSelect').value || 'all';
    } else if (currentMode === 'month') {
      modeLabel = document.getElementById('monthSelect').value || 'month';
    } else {
      modeLabel = (document.getElementById('eventSelect').value || 'event')
        + '_' + (document.getElementById('monthSelect').value || 'month');
    }
    const kubunVal = document.getElementById('kubunSelect').value || 'all';
    if (kubunVal !== 'all') {
      modeLabel += `_kubun-${kubunVal}`;
    }
    a.href = url;
    a.download = `seinen-report_${currentMode}_${modeLabel}_${stamp}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /***** メイン処理 *****/
  (async function init() {
    const status = document.getElementById('status');
    status.textContent = '読み込み中…';

    try {
      allData = await fetchSheetData();
      if (!allData.length) {
        status.textContent = '回答がまだありません。';
        return;
      }
      groupDataStructures(allData);

      const eventSelect = document.getElementById('eventSelect');
      eventSelect.innerHTML = '';
      for (const key of byEvent.keys()) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        eventSelect.appendChild(opt);
      }

      const monthSelect = document.getElementById('monthSelect');
      monthSelect.innerHTML = '';
      const monthKeys = Array.from(byMonth.keys()).sort();
      monthKeys.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k;
        monthSelect.appendChild(opt);
      });

      // 表示モードボタン
      document.getElementById('modeEvent').addEventListener('click', () => {
        currentMode = 'event';
        setModeButtonsActive('modeEvent');
        document.getElementById('eventSelectGroup').style.display = '';
        document.getElementById('monthSelectGroup').style.display = 'none';
        updateForSelection();
      });
      document.getElementById('modeMonth').addEventListener('click', () => {
        currentMode = 'month';
        setModeButtonsActive('modeMonth');
        document.getElementById('eventSelectGroup').style.display = 'none';
        document.getElementById('monthSelectGroup').style.display = '';
        updateForSelection();
      });
      document.getElementById('modeEventMonth').addEventListener('click', () => {
        currentMode = 'eventMonth';
        setModeButtonsActive('modeEventMonth');
        document.getElementById('eventSelectGroup').style.display = '';
        document.getElementById('monthSelectGroup').style.display = '';
        updateForSelection();
      });

      // 行事 / 月セレクト
      eventSelect.addEventListener('change', updateForSelection);
      monthSelect.addEventListener('change', updateForSelection);

      // 区分セレクト
      document.getElementById('kubunSelect').addEventListener('change', updateForSelection);

      // 指標選択
      document.getElementById('metricSelect').addEventListener('change', (e) => {
        currentMetric = e.target.value;
        if (currentSummary) {
          const rows = getCurrentRows();
          updateCharts(currentSummary, rows);
        }
      });

      // CSV
      document.getElementById('csvBtn').addEventListener('click', () => {
        const rows = getCurrentRows();
        exportCsv(rows);
      });

      updateForSelection();
      status.textContent = '';

    } catch (e) {
      console.error(e);
      document.getElementById('status').textContent = 'データ取得エラー: ' + e.message;
    }
  })();

  function setModeButtonsActive(id) {
    ['modeEvent','modeMonth','modeEventMonth'].forEach(btnId => {
      const el = document.getElementById(btnId);
      if (!el) return;
      if (btnId === id) el.classList.add('active');
      else el.classList.remove('active');
    });
  }

  // ★ 区分フィルタを適用する共通関数
  function applyKubunFilter(rows) {
    const kubun = document.getElementById('kubunSelect')?.value || 'all';
    if (kubun === 'all') return rows;
    return rows.filter(r => (String(r.kubun || '').trim() === kubun));
  }

  function getCurrentRows() {
    let baseRows;
    if (currentMode === 'event') {
      const key = document.getElementById('eventSelect').value;
      baseRows = byEvent.get(key) || [];
    } else if (currentMode === 'month') {
      const key = document.getElementById('monthSelect').value;
      baseRows = byMonth.get(key) || [];
    } else { // eventMonth
      const eKey = document.getElementById('eventSelect').value;
      const mKey = document.getElementById('monthSelect').value;
      baseRows = allData.filter(r =>
        (r.eventName || '') === eKey &&
        getMonthKey(r.date || r.timestamp) === mKey
      );
    }
    return applyKubunFilter(baseRows);
  }

  function updateForSelection() {
    const status = document.getElementById('status');
    const rows = getCurrentRows();
    if (!rows.length) {
      status.textContent = 'この条件の回答はまだありません。';
      currentSummary = null;
      // グラフを消すよりもそのままにしておく仕様のまま
      return;
    }
    status.textContent = '';

    const kubunVal = document.getElementById('kubunSelect').value || 'all';

    let label;
    if (currentMode === 'event') {
      label = document.getElementById('eventSelect').value;
    } else if (currentMode === 'month') {
      label = document.getElementById('monthSelect').value;
    } else {
      label = document.getElementById('eventSelect').value
        + ' × ' + document.getElementById('monthSelect').value;
    }
    if (kubunVal !== 'all') {
      label += `（区分：${kubunVal}）`;
    }

    currentSummary = calcSummary(rows, label);
    updateSummaryCards(currentSummary);
    updateCharts(currentSummary, rows);
    updateComments(currentSummary);
    updateInsight(currentSummary, currentMode);
  }
</script>
</body>
</html>
